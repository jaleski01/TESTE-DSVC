
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * FUNÇÕES DE UTILITÁRIO DE SEGURANÇA
     */
     
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usuário autenticado é o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Impede a modificação de campos que devem ser controlados apenas pelo servidor/admin
    function isNotModifyingSensitiveFields() {
      let sensitiveFields = [
        'subscription_status', 
        'stripe_customer_id', 
        'stripeCustomerId',
        'email', 
        'created_at', 
        'onboarding_completed_at',
        'role',
        'reboot_projection_days'
      ];
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(sensitiveFields);
    }

    // Valida que o campo de atualização de tempo é o tempo do servidor
    function isValidTimestamp() {
      return request.resource.data.last_updated == request.time;
    }

    /**
     * REGRAS DE COLEÇÕES
     */

    match /users/{userId} {
      // Leitura permitida apenas para o dono
      allow get: if isOwner(userId);
      
      // Listagem proibida para prevenir scraping de base
      allow list: if false;

      // Criação inicial (Provisionamento seguro)
      allow create: if isOwner(userId) 
        && (!('subscription_status' in request.resource.data) || request.resource.data.subscription_status == 'inactive')
        && request.resource.data.created_at == request.time;

      // Atualização de perfil (Proteção de Paywall e Integridade)
      allow update: if isOwner(userId) 
        && isNotModifyingSensitiveFields()
        && isValidTimestamp();

      // Deleção proibida via cliente
      allow delete: if false;

      /**
       * SUB-COLEÇÕES (SEGURANÇA POR HERANÇA)
       */
       
      match /daily_history/{date} {
        // Histórico diário deve ser acessível apenas pelo dono
        allow read, write: if isOwner(userId);
      }

      match /trigger_logs/{logId} {
        // Logs de gatilhos são dados sensíveis de saúde mental
        allow read, write: if isOwner(userId);
      }
      
      match /epitaph_logs/{epitaphId} {
        // Histórico de epitáfios imutável pelo dono
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.created_at == request.time;
        allow update, delete: if false; // Epitáfios são marcos históricos inalteráveis
      }
    }

    // Bloqueio padrão para qualquer rota não mapeada
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
